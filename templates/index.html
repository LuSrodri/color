<html>

<head>
  <title>Processamento de Sinais</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <link rel="stylesheet" href="../static/css/index.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  button {
    margin: 0.5vmin;
  }

  img {
    margin: 1vmin;
    border: solid black 1.5vmin;
    border-radius: 3vmin;
  }

  div.divColors {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-around;
  }

  span.button {
    font-size: 2vmin;
    color: white;
    font-weight: bolder;
    background-color: #1e1e1e;
  }

  h1#title {
    padding: 0;
    margin-top: 2vmin;
    margin-bottom: 0;
    font-size: 6vmin;
    font-weight: bolder;
  }

  a {
    text-decoration: none;
    color: black;
  }

  #inputImage {
    font-size: 4vmin;
  }

  .colorsButton {
    border: solid black 0.5vmin;
    margin: 0.25vmin;
  }

  @media (orientation: landscape) {
    img {
      width: auto;
      height: 75vh;
    }
  }

  @media (orientation: portrait) {
    img {
      width: 75vw;
      height: auto;
    }
  }
</style>

<body>
  <div id="main" style="display: flex; flex-direction: column; align-items: center; padding: 3vmin;">
    <h1 id="title"><a href="/">Insira uma imagem</a></h1>
    <form id="form" method="post" action="/getcolorpalettebyimage" enctype="multipart/form-data">
      <input id="inputImage" type="file" name="file" autocomplete="off" required accept="image/jpeg, image/png"
        autofocus>
    </form>
    <img id="image" src="" alt="" style="display: none;">
    <img id="imageResult" src="" alt="" style="display: none;">

    <h3 id="loadingText" style="display: none;">Processando</h3>
    <div id="loading" style="display: none;">
      <h2>Paletas de cores retirada usando o <a href="https://scikit-learn.org/stable/index.html"> Scikit-Learn</a></h2>
      <div id="colorsByScikit-Learn" class="divColors">
        <!-- mostrando as cores -->
      </div>
      <h2>Paletas de cores retirada usando o <a href="https://lokeshdhakar.com/projects/color-thief/"> Color Thief</a>
      </h2>
      <div id="colorsByColorThief" class="divColors">
        <!-- mostrando as cores -->
      </div>
      <h2>Paletas de cores retirada usando o <a href="https://github.com/CairX/extract-colors-py"> Ext Colors</a></h2>
      <div id="colorsByExtColors" class="divColors">
        <!-- mostrando as cores -->
      </div>
      <h2>Remover canal de cores</h2>
      <div>
        <button class="btn btn-danger" onclick="removeChannelColorRequest('red')">Vermelho(RED)</button>
        <button class="btn btn-success" onclick="removeChannelColorRequest('green')">Verde(GREEN)</button>
        <button class="btn btn-primary" onclick="removeChannelColorRequest('blue')">Azul(BLUE)</button>
      </div>
      <br>
      <hr>
      <button class="btn btn-primary" onclick="backToStandard()">
        <h2>Voltar ao padr√£o</h2>
      </button>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</body>

<script>
  let imageFile;
  let colorsRequest = new Set();
  let imageInput = document.getElementById("inputImage");
  let image = document.getElementById("image");
  let imageResult = document.getElementById("imageResult");
  let form = document.getElementById("form");
  let data = new FormData();
  imageInput.addEventListener("input", async () => {
    if (imageInput.files && imageInput.files[0]) {
      document.getElementById("loadingText").style.display = "unset";
      let reader = new FileReader();
      reader.onload = async (e) => {
        image.src = e.target.result;
        image.style.display = "unset";
        imageInput.style.display = "none";
        await data.append('file', imageInput.files[0]);
        imageFile = imageInput.files[0];
        axios.post('/getcolorpalettebyimage', data)
          .then((response) => {
            showColorPaletteByScikitLearn(response);
            showColorPaletteByColorThief(response);
            showColorPaletteByExtColors(response);
            document.getElementById("loadingText").style.display = "none";
            document.getElementById("loading").style.display = "unset"
            console.log(response);
          }, (error) => { });
        // document.getElementById("main").removeChild(document.getElementById("title"));
      };
      reader.readAsDataURL(imageInput.files[0]);
    }
  })

  function showColorPaletteByScikitLearn(response) {
    let colorsElement = document.getElementsByClassName("colorsByScikit-Learn");
    colorsData = response.data.colorsByKmeans;

    for (let i = 0; i < colorsData.length; i++) {
      if ((colorsData[i][0] * 100) > 1) {
        colorsElement = document.createElement("button");
        colorsElement.className = "colorsButton";
        colorsElement.style.width = "13vmin";
        colorsElement.style.height = "13vmin";
        colorsElement.style.backgroundColor = 'rgb(' + colorsData[i][1][0] + ',' + colorsData[i][1][1] + ',' + colorsData[i][1][2] + ')';
        spanText = document.createElement("span");
        spanText.innerHTML = `${(colorsData[i][0] * 100).toFixed(2)}%`;
        spanText.className = "button";
        colorsElement.appendChild(spanText);
        colorsElement.addEventListener("click", (e) => {
          let colorOfElement = e.target.style.backgroundColor;
          if (colorOfElement !== '')
            setColorsRequest(e.target.style.backgroundColor);
        });

        document.getElementById("colorsByScikit-Learn").appendChild(colorsElement);
      }
    }
    document.getElementsByClassName("colorsButton")[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function showColorPaletteByColorThief(response) {
    let colorsElement = document.getElementsByClassName("colorsByColorThief");
    colorsData = response.data.colorByColorThief;

    dominantColor = document.createElement("button");
    dominantColor.className = "colorsButton";
    dominantColor.style.width = "16vmin";
    dominantColor.style.height = "16vmin";
    dominantColor.style.backgroundColor = 'rgb(' + colorsData[0][0] + ',' + colorsData[0][1] + ',' + colorsData[0][2] + ')';
    dominantColor.addEventListener("click", (e) => {
      let colorOfElement = e.target.style.backgroundColor;
      if (colorOfElement !== '')
        setColorsRequest(e.target.style.backgroundColor);
    });

    document.getElementById("colorsByColorThief").appendChild(dominantColor);

    for (let i = 1; i < colorsData.length; i++) {
      colorsElement = document.createElement("button");
      colorsElement.className = "colorsButton";
      colorsElement.style.width = "13vmin";
      colorsElement.style.height = "13vmin";
      colorsElement.style.backgroundColor = 'rgb(' + colorsData[i][0] + ',' + colorsData[i][1] + ',' + colorsData[i][2] + ')';
      colorsElement.addEventListener("click", (e) => {
        let colorOfElement = e.target.style.backgroundColor;
        if (colorOfElement !== '')
          setColorsRequest(e.target.style.backgroundColor);
      });

      document.getElementById("colorsByColorThief").appendChild(colorsElement);
    }
    document.getElementsByClassName("colorsButton")[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function showColorPaletteByExtColors(response) {
    let colorsElement = document.getElementsByClassName("colorsByExtColors");
    colorsData = response.data.colorsByExtColor;

    for (let i = 0; i < colorsData.length; i++) {
      if (colorsData[i][0] > 1) {
        colorsElement = document.createElement("button");
        colorsElement.className = "colorsButton";
        colorsElement.style.width = "13vmin";
        colorsElement.style.height = "13vmin";
        colorsElement.style.backgroundColor = 'rgb(' + colorsData[i][1][0][0] + ',' + colorsData[i][1][0][1] + ',' + colorsData[i][1][0][2] + ')';
        spanText = document.createElement("span");
        spanText.innerHTML = `${(colorsData[i][0]).toFixed(2)}%`;
        spanText.className = "button";
        colorsElement.appendChild(spanText);
        colorsElement.addEventListener("click", (e) => {
          let colorOfElement = e.target.style.backgroundColor;
          if (colorOfElement !== '')
            setColorsRequest(e.target.style.backgroundColor);
        });

        document.getElementById("colorsByExtColors").appendChild(colorsElement);
      }
    }
    document.getElementsByClassName("colorsButton")[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function setColorsRequest(color) {
    document.getElementById("loadingText").style.display = "unset";
    document.getElementById("loading").style.display = "none";
    color = color.replace('rgb(', '').replace(')', '').split(',').map(Number);
    // for (const arr of colorsRequest) {
    //   if (arr.toString() === color.toString()) {
    //     colorsRequest.delete(arr);
    //     getModifiedImage(colorsRequest);
    //     return 0;
    //   }
    // }
    // colorsRequest.add(color);
    // getModifiedImage(colorsRequest);
    // return 0;
    removeColorRequest(color);
  }

  async function removeColorRequest(colorsToSend) {
    let reader = new FileReader();
    reader.onload = (e) => {
      imageResult.src = e.target.result;
      image.style.display = "none";
      imageResult.style.display = "unset";
      document.getElementById("loadingText").style.display = "none";
      document.getElementById("loading").style.display = "unset"
    };
    if (colorsToSend.length > 0) {
      axios.post('/removeColor', { "colorsToSend": colorsToSend }, { responseType: 'blob' })
        .then((response) => {
          reader.readAsDataURL(response.data);
        }, (error) => { });
    }
    else {
      imageResult.style.display = "none";
      image.style.display = "unset";
    }
  }

  let count = 0;
  loadingText();
  function loadingText() {
    setInterval(() => {
      if (count >= 3) {
        count = 0;
        document.getElementById("loadingText").innerHTML = "Processando";
      }
      document.getElementById("loadingText").innerHTML += ".";
      count++;
    }, 300);
  }

  function backToStandard() {
    document.getElementById("image").style.display = "unset";
    document.getElementById("imageResult").style.display = "none";

    document.getElementById("image").scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  async function removeChannelColorRequest(colorsToSend) {
    document.getElementById("loadingText").style.display = "unset";
    document.getElementById("loading").style.display = "none";
    let reader = new FileReader();
    reader.onload = (e) => {
      imageResult.src = e.target.result;
      image.style.display = "none";
      imageResult.style.display = "unset";
      document.getElementById("loadingText").style.display = "none";
      document.getElementById("loading").style.display = "unset";
    };
    if (colorsToSend.length > 0) {
      axios.post('/removeColor', { "colorsToSend": colorsToSend }, { responseType: 'blob' })
        .then((response) => {
          reader.readAsDataURL(response.data);
        }, (error) => { });
    }
    else {
      imageResult.style.display = "none";
      image.style.display = "unset";
    }
  }
</script>

</html>